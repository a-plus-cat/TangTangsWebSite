extends layout

block main
  #photoAlbum(style='cursor:grab;')
    .hard.frontCover#albumTitle TangTang's photos
    .hard.frontBack
    - for (let i = 0; i < photoList.length; i += 1)
      .contentPage.unselectable
        if i % 2
          span.bookmark.swingFont.rightAlign(title='Âä†ÂÖ•Êõ∏Á±§')
            i.far &#xf005;
          span.pageNum.leftAlign #{i + 1}
          if member && member.id === photoList[i].provider.toString()
            span.deleteBtn.swingFont.rightAlign(title='Ââ™‰∏ãÁÖßÁâá')
              i.fas &#xf0c4;
        else
          span.bookmark.swingFont.leftAlign(title='Âä†ÂÖ•Êõ∏Á±§')
            i.far &#xf005;
          span.pageNum.rightAlign #{i + 1}
          if member && member.id === photoList[i].provider.toString()
            span.deleteBtn.swingFont.leftAlign(title='Ââ™‰∏ãÁÖßÁâá')
              i.fas &#xf0c4;
        if photoList[i].url
          img.photo(id=photoList[i].id src=photoList[i].url width='70%' style='cursor:zoom-in;')
        else
          img.photo(id=photoList[i].id src=`/photoAlbum/photo/${photoList[i].id}` width='70%' style='cursor:zoom-in;')
    if photoList.length % 2
      .contentPage
    .hard.endBack
    .hard.endCover
  .text-center.mt-5#albumControl
    if member
      button.btn.btn-danger.mr-1#delPhotos(title='Âà™Èô§ÂúñÁâá')
        i.fas &#xf2ed;
      button.btn.btn-primary.mr-1#addPhotos(title='Êñ∞Â¢ûÂúñÁâá')
        i.fas &#xf093;
    else
      a.btn.btn-secondary.mr-1(href='/photoAlbum/getPremission' title='Êñ∞Â¢ûÂúñÁâá')
        i.fas &#xf093;
    button.btn.btn-success.mr-1#prePage(title='‰∏ä‰∏ÄÈ†Å') 
      i.fas &#xf137;
    button.btn.btn-success.mr-1#nextPage(title='‰∏ã‰∏ÄÈ†Å') 
      i.fas &#xf138;
    .btn(style='padding:0')
      .input-group.input-group-lg
        .input-group-prepend
          lable.input-group-text.fieldName(for='pages') Ë∑≥ËΩâÈ†ÅÈù¢
        div(style='position:relative')
          select.custom-select#pages(name='pages' data-live-search="true")
            - for (let i = 1; i <= photoList.length; i += 1) 
              option(value=`${i}`) #{i}
  #screenMask
  .modal#photoAlert
    .modal-dialog.modal-dialog-centered
      .modal-content
        .modal-header
          if success.toString()
            h3.modal-title Tang-Tang „ÅÆ Â∞èÊèêÈÜí
          else
            h3.modal-title ‚ö†Ô∏è ÈåØË™§Ë®äÊÅØ
        .modal-body
          if success.toString()
            .alert.alert-success#okMsg #{success}
          else
            .alert.alert-danger#errMsg #{failure}
        .modal-footer
          button.btn.btn-danger(type='button' data-dismiss='modal') ÈóúÈñâ
  .modal#zoomImg
    .modal-dialog.modal-lg.modal-dialog-centered.modal-dialog-scrollable
      .modal-content
        .modal-header
          h3.modal-title TangTang „ÅÆ photo
        .modal-body.text-center
          img#showZoomImg(src='' style='max-width:100%;max-height:100%;')
        .modal-footer
          button.btn.btn-danger(type='button' data-dismiss='modal') ÈóúÈñâ
  if member
    .modal#addImg
      .modal-dialog.modal-lg.modal-dialog-centered
        .modal-content
          .modal-header
            ul.nav.nav-pills(role='tablist')
              li.nav-item: a.nav-link.active(data-toggle='pill' href='#localPaste') Êú¨Âú∞‰∏äÂÇ≥
              li.nav-item: a.nav-link(data-toggle='pill' href='#urlPaste') Á∂≤ÂùÄÈÄ£Áµê
          .modal-body.d-flex.justify-content-center
            .tab-content(style='width:100%;')
              #localPaste.unselectable.container.tab-pane.active
                form#photoUpload(
                  action=`?_csrf=${csrfToken}`
                  method="post" 
                  enctype="multipart/form-data" 
                  style='width:100%;height:100%;'
                )
                  label.imgUpload#uploadNotice(for='photos')
                    span.flashingWord ÈªûÊ≠§‰∏äÂÇ≥ÂúñÁâá(Êï∏Èáè‰∏äÈôê:5 ÂñÆÊ™îÂ§ßÂ∞è‰∏äÈôê:10MB) 
                    i.fas.cloudIcon &#xf382;
                    i.fas.arrowIcon &#xf102;
                  input#photos(type="file" name="photos" accept="image/*" multiple required)
                  input(type='hidden' name='provider' value=member.id)
              #urlPaste.container.tab-pane
                form#urlUpload(action=`/imgUrl/?_csrf=${csrfToken}` method="post")
                  .input-group.d-flex.justify-content-center
                    .input-group-prepend
                      label.input-group-text.fieldName(for='photo') ÂúñÁâá‰æÜÊ∫ê
                    input#photo(type="text" name="photo" style='width:60%' required)
                  input(type='hidden' name='provider' value=member.id)
          .modal-footer.d-flex.justify-content-center
            button.btn.btn-success#uploadPhoto(type='button') Áõ∏ÁâáÈªèË≤º
    .modal#delImg
      .modal-dialog.modal-dialog-centered
        .modal-content
          .modal-header
            h3.modal-title ‚ö†Ô∏è Âà™Èô§Áõ∏Áâá
          .modal-body
            p.text-danger.font-weight-bold.lead Á¢∫ÂÆöË¶ÅÂ∞áÂ∑≤Ââ™‰∏ãÁöÑÁõ∏ÁâáÂà™Èô§?
            p.small.font-italic (ÈªûÈÅ∏Áõ∏Á∞øÂâ™ÂàÄÂúñÁ§∫Âç≥ÂèØÂâ™‰∏ãÁõ∏Áâá)
          .modal-footer.d-flex.justify-content-center
            button.btn.btn-danger#deletePhoto(type='button') Âà™Èô§
            button.btn.btn-secondary(type='button' data-dismiss='modal') ÂèñÊ∂à
  script.
    let show = true;
    const garbageCan = {};
    const insideAlbum = $("#photoAlbum").html();

    function magnifyPhoto() {
      $('#showZoomImg').attr('src', $(this).attr('src'));
      $('#zoomImg').modal('show');
    }

    $(document).ready(function(){
      $('#screenMask').hide();
      if ($('#errMsg').text() || $('#okMsg').text()) $('#photoAlert').modal('show');

      if (window.innerWidth > 900) {
        $("#photoAlbum").turn({
          width: '70%',
          height: '50vh',
          autoCenter: true
        });
      } else show = false;

      $('#delPhotos').on('click', () => $('#delImg').modal('show'));

      $('#deletePhoto').on('click', () => {
        const idCollect = Object.keys(garbageCan);
        if (!idCollect.length) {
          alert('Êú™Ââ™‰∏ã‰ªª‰ΩïÁõ∏Áâá!!!');
          $('#delImg').modal('hide');
        } else {
          // remove pasted back photo's id
          for(let i = 0; i < idCollect.length; i += 1) {
            if (garbageCan[idCollect[i]].value) delete garbageCan[idCollect[i]];
          }
          const delIdStr = JSON.stringify(Object.keys(garbageCan));
          const token = '#{csrfToken}';
          const location = window.location.href;

          $.ajax({
            method: 'POST',
            type: 'POST',
            url: `/photoAlbum/deletePhoto?_csrf=${token}`,
            contentType: "application/json; charset=utf-8",
            data: delIdStr
          })
          .done((data) => {
            if (data) alert('Áõ∏ÁâáÂà™Èô§ÊàêÂäü!!!');
            else alert('Áõ∏ÁâáÂà™Èô§Â§±Êïó...Ë´ãÁ®çÂæåÂÜçË©¶');
            window.location.replace(location);
          })
          .fail(() => alert('Âà™Èô§ËôïÁêÜÂ§±Êïó....'));
        }
      });

      $('#addPhotos').on('click', () => $('#addImg').modal('show'));

      $('#uploadPhoto').on('click', function () {
        if ($('#localPaste').hasClass('active')) {
          $('#uploadNotice').html(
            '<span class="spinner-border text-primary"></span><span style="font-size:24px">ÂúñÁâá‰∏äÂÇ≥‰∏≠...Ë´ãÁ®çÂæå</span>'
          );
          $('#screenMask').show();
          $('#photoUpload').submit();
        } 
      });

      $('#prePage').on('click', function () {
        $("#photoAlbum").turn("previous");
      });

      $('#nextPage').on('click', function () {
        $("#photoAlbum").turn("next");
      });
      
      $('#pages').on('focus', function () {this.size = 3;});
      $('#pages').on('blur', function () {this.size = 1;});
      $('#pages').on('change', function () {
        this.size = 1;
        this.blur();
        const targetPage = parseInt(this.value) + 2;
        $("#photoAlbum").turn('page', targetPage);
      });

      if (window.innerWidth <= 850) $('.photo').on('click', magnifyPhoto);
    });

    $(window).resize(function() {
      if (window.innerWidth > 850) {
        if (show) $("#photoAlbum").turn('size', '70%', '50vh');
        else {
          $("#photoAlbum").turn({
            width: '70%',
            height: '50vh',
            autoCenter: true
          });
          show = true;
        }
      } else {
        if (show) {
          $("#photoAlbum").turn("destroy").remove();
          const e = document.createElement('div');
          $(e).attr('id', "photoAlbum");
          $(e).html(insideAlbum);
          $('#zoomImg').before(e);
          show = false;
          setTimeout(() => window.location.reload());
        }
      } 
    });

    $("#photoAlbum").bind("turned", function(event, page, view) {
      $('.photo').off('click');
      $('.bookmark').off('click');
      $('.deleteBtn').off('click');

      $('.photo').on('click', magnifyPhoto);
      
      $('.bookmark').on('click', function () {
        const pageNum = $(this).next().text();
        if ($(this).find('i').is('.far')) {
          $(this).empty().append('<i class="fas">&#xf005;</i>');
          $(this).css('color', 'orange');
          $(this).attr('title', 'ÂèñÊ∂àÊõ∏Á±§');
          $('#pages > option').eq(pageNum - 1).text(`${pageNum}  üåü`);
        } else {
          $(this).empty().append('<i class="far">&#xf005;</i>');
          $(this).css('color', 'black');
          $(this).attr('title', 'Âä†ÂÖ•Êõ∏Á±§');
          $('#pages > option').eq(pageNum - 1).text(pageNum);
        }        
      });

      $('.deleteBtn').on('click', function () {
        if ($(this).find('i').is('.fas')) {
          $(this).empty().append('<i class="far">&#xf1c5;</i>');
          $(this).css('color', 'lightskyblue');
          $(this).next().hide();
          garbageCan[$(this).next().attr('id')] = true;
          $(this).attr('title', 'Ë≤ºÂõûÁÖßÁâá');
        } else {
          $(this).empty().append('<i class="fas">&#xf0c4;</i>');
          $(this).css('color', 'gray');
          $(this).next().show();
          garbageCan[$(this).next().attr('id')] = false;
          $(this).attr('title', 'Ââ™‰∏ãÁÖßÁâá');
        }
      });
    });