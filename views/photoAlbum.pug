extends layout

block main
  #photoAlbum(style='cursor:grab;')
    .hard.frontCover#albumTitle TangTang's photos
    .hard.frontBack
    - for (let i = 0; i < photoList.length; i += 1)
      .contentPage.unselectable
        if i % 2
          span.bookmark.swingFont.rightAlign(title='加入書籤')
            i.far &#xf005;
          span.pageNum.leftAlign #{i + 1}
          if member && member.id === photoList[i].provider.toString()
            span.deleteBtn.swingFont.rightAlign(title='剪下照片')
              i.fas &#xf0c4;
        else
          span.bookmark.swingFont.leftAlign(title='加入書籤')
            i.far &#xf005;
          span.pageNum.rightAlign #{i + 1}
          if member && member.id === photoList[i].provider.toString()
            span.deleteBtn.swingFont.leftAlign(title='剪下照片')
              i.fas &#xf0c4;
        if photoList[i].url
          img.photo(id=photoList[i].id src=photoList[i].url width='70%' style='cursor:zoom-in;')
        else
          img.photo(id=photoList[i].id src=`/photoAlbum/photo/${photoList[i].id}` width='70%' style='cursor:zoom-in;')
    if photoList.length % 2
      .contentPage
    .hard.endBack
    .hard.endCover
  .text-center.mt-4#albumControl
    if member
      button.btn.btn-danger.mr-1#delPhotos(title='刪除圖片')
        i.fas &#xf2ed;
      button.btn.btn-primary.mr-1#addPhotos(title='新增圖片')
        i.fas &#xf093;
    else
      a.btn.btn-secondary.mr-1(href='/photoAlbum/getPremission' title='新增圖片')
        i.fas &#xf093;
    button.btn.btn-success.mr-1#prePage(title='上一頁') 
      i.fas &#xf137;
    button.btn.btn-success.mr-1#nextPage(title='下一頁') 
      i.fas &#xf138;
    .btn(style='padding:0')
      .input-group.input-group-lg
        .input-group-prepend
          lable.input-group-text.fieldName(for='pages') 跳轉頁面
        div(style='position:relative')
          select.custom-select#pages(name='pages' data-live-search="true")
            option(value='-1') 封面
            - for (let i = 1; i <= photoList.length; i += 1) 
              option(value=`${i}`) #{i}
            option(value=`${photoList.length + 2 + photoList.length % 2}`) 封底
  #screenMask
    .d-flex.justify-content-center.align-items-center(style='height:100%;')
      span.spinner-border.text-primary(style='width:4rem;height:4rem;')
      span.display-1#loadingMsg  圖片加載中.....
  .modal#photoAlert
    .modal-dialog.modal-dialog-centered
      .modal-content
        .modal-header
          if success.toString()
            h3.modal-title Tang-Tang の 小提醒
          else
            h3.modal-title ⚠️ 錯誤訊息
        .modal-body
          if success.toString()
            .alert.alert-success#okMsg #{success}
          else
            .alert.alert-danger#errMsg #{failure}
        .modal-footer
          button.btn.btn-danger(type='button' data-dismiss='modal') 關閉
  .modal#zoomImg
    .modal-dialog.modal-lg.modal-dialog-centered.modal-dialog-scrollable
      .modal-content
        .modal-header
          h3.modal-title TangTang の photo
        .modal-body.text-center
          img#showZoomImg(src='' style='max-width:100%;max-height:100%;')
        .modal-footer
          button.btn.btn-danger(type='button' data-dismiss='modal') 關閉
  if member
    .modal#addImg
      .modal-dialog.modal-lg.modal-dialog-centered
        .modal-content
          .modal-header
            ul.nav.nav-pills(role='tablist')
              li.nav-item: a.nav-link.active#fileInput(data-toggle='pill' href='#localPaste') 本地上傳
              li.nav-item: a.nav-link#urlInput(data-toggle='pill' href='#urlPaste') 網址連結
          .modal-body.d-flex.justify-content-center
            .tab-content(style='width:100%;')
              #localPaste.unselectable.container.tab-pane.active
                form#photoUpload(
                  action=`/photoAlbum/imgFile?_csrf=${csrfToken}`
                  method="post" 
                  enctype="multipart/form-data" 
                  style='width:100%;height:100%;'
                )
                  label.imgUpload#uploadNotice(for='photos')
                    span.flashingWord 點此上傳圖片(數量上限:5 單檔大小上限:10MB) 
                    i.fas.cloudIcon &#xf382;
                    i.fas.arrowIcon &#xf102;
                  input#photos(type="file" name="photos" accept="image/*" multiple required)
                  input(type='hidden' name='provider' value=member.id)
              #urlPaste.container.tab-pane
                form#urlUpload(action=`/photoAlbum/imgUrl` method="post")
                  .input-group.d-flex.justify-content-center
                    .input-group-prepend
                      label.input-group-text.fieldName(for='photo') 圖片來源
                    input#photo(
                      type="text" 
                      name="photo" 
                      style='width:60%'
                      data-toggle="tooltip"
                      title="請輸入有效的圖片連結"
                      placeholder='⚠️ 只接受https網址連結!!!'
                      value=''
                      required
                    )
                  input(type='hidden' name='provider' value=member.id)
                  input(type='hidden' name='_csrf' value=csrfToken)
                .d-flex.justify-content-center.mt-3.unselectable
                  img#uploadPreview(src='/images/addImage.png' style='width:128px')
          .modal-footer.d-flex.justify-content-center
            button.btn.btn-success#uploadPhoto(type='button') 相片黏貼
    .modal#delImg
      .modal-dialog.modal-dialog-centered
        .modal-content
          .modal-header
            h3.modal-title ⚠️ 刪除相片
          .modal-body
            p.text-danger.font-weight-bold.lead 確定要將已剪下的相片刪除?
            p.small.font-italic (點選相簿剪刀圖示即可剪下相片)
          .modal-footer.d-flex.justify-content-center
            button.btn.btn-danger#deletePhoto(type='button') 刪除
            button.btn.btn-secondary(type='button' data-dismiss='modal') 取消
  script.
    let show = true;
    const garbageCan = {};
    const insideAlbum = $("#photoAlbum").html();

    function magnifyPhoto() {
      $('#showZoomImg').attr('src', $(this).attr('src'));
      $('#zoomImg').modal('show');
    }

    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip({placement: "top", trigger: "manual"});
      if ($('#errMsg').text() || $('#okMsg').text()) $('#photoAlert').modal('show');

      if (window.innerWidth > 900) {
        $("#photoAlbum").turn({
          width: '70%',
          height: '50vh',
          autoCenter: true
        });
      } else show = false;

      $('#delPhotos').on('click', () => $('#delImg').modal('show'));

      $('#deletePhoto').on('click', () => {
        const idCollect = Object.keys(garbageCan);

        if (!idCollect.length) {
          alert('未剪下任何相片!!!');
          $('#delImg').modal('hide');
        } else {
          // remove pasted back photo's id
          for(let i = 0; i < idCollect.length; i += 1) {
            if (garbageCan[idCollect[i]].value) delete garbageCan[idCollect[i]];
          }

          const delIdStr = JSON.stringify(Object.keys(garbageCan));
          const token = '#{csrfToken}';
          const location = window.location.href;

          $.ajax({
            method: 'POST',
            type: 'POST',
            url: `/photoAlbum/deletePhoto?_csrf=${token}`,
            contentType: "application/json; charset=utf-8",
            data: delIdStr
          })
          .done((data) => {
            $('#screenMask').empty();
            $('#screenMask').show();
            if (data) alert('相片刪除成功!!!');
            else alert('相片刪除失敗...請稍後再試');
            window.location.replace(location);
          })
          .fail(() => alert('刪除處理失敗....請重新嘗試'));
        }
      });

      $('#addPhotos').on('click', () => {
        $('#addImg').modal('show');
        $('#fileInput').click();
      });

      $('#uploadPreview').on('load', function () {
        const imgSrc = $(this).attr('src');

        $('#screenMask').removeClass('d-flex justify-content-center align-items-center');

        if (imgSrc !== '/images/noImage.png' && imgSrc !== '/images/addImage.png') {
          $(this).css({'width':'70%','max-height':'40%'});
          $('#uploadPhoto').removeAttr('disabled');
        } else {
          $('#urlUpload').trigger('reset');
          if (imgSrc === '/images/noImage.png') $("[data-toggle='tooltip']").tooltip('show');
        }
      });

      $('#fileInput').on('click', () => {
        $('#uploadPhoto').removeAttr('disabled');
        $("[data-toggle='tooltip']").tooltip('hide');
      });

      $('#urlInput').on('click', () => {
        $('#urlUpload').trigger('reset');
        $('#uploadPhoto').attr('disabled', 'true');
        $('#uploadPreview').attr('src', '/images/addImage.png');
        $('#uploadPreview').css('width', '128px');
      });

      $('#uploadPreview').on('error', function () {
        $(this)
          .attr('src', '/images/noImage.png')
          .css('width', '128px');
      });

      $('#photo').on('focus', () => {
        $('#uploadPhoto').attr('disabled', 'true')
        $("[data-toggle='tooltip']").tooltip('hide');
      });

      $('#photo').on('blur', function () {
        const preview = $('#uploadPreview').get(0);
        const rule = /(^https:\/\/(?:[a-z0-9\-]+\.)+[a-z0-9]+\/(?:[^\s\/]+\/)*[^\\\/\:\?\*\"<>\|]+\.(?:jpg|jpeg|gif|png))(?:\?[^\?]*)?$/i;
        const urlStr = this.value;
        const isUrl = urlStr.match(rule);
        if (isUrl) {
          $('#uploadPreview').attr('src', isUrl[1]);
          if (!preview.complete) {
            $('#screenMask').addClass('d-flex justify-content-center align-items-center');
          }
        } else {
          $('#urlUpload').trigger('reset');
          $('#uploadPreview').attr('src', '/images/addImage.png');
          $('#uploadPreview').css('width', '128px');
          $("[data-toggle='tooltip']").tooltip('show');
        }
      });

      $('#uploadPhoto').on('click', function () {
        const processMsg = '<span class="spinner-border text-primary"></span><span style="font-size:24px">圖片上傳中...請稍後</span>';
        if ($('#localPaste').hasClass('active')) {
          if ($('#photos').get(0).files.length) {
            $('#uploadNotice').html(processMsg);
            $('#screenMask').empty()
            $('#screenMask').show();
            $('#photoUpload').submit();
          } else alert('請選擇上傳圖檔!!!');
        } else {
          $('#screenMask').show();
          $('#urlUpload').submit();
        }
      });

      $('#prePage').on('click', function () {
        $("#photoAlbum").turn("previous");
      });

      $('#nextPage').on('click', function () {
        $("#photoAlbum").turn("next");
      });
      
      $('#pages').on('focus', function () {this.size = 3;});
      $('#pages').on('blur', function () {this.size = 1;});
      $('#pages').on('change', function () {
        this.size = 1;
        this.blur();
        const targetPage = parseInt(this.value) + 2;
        $("#photoAlbum").turn('page', targetPage);
      });

      if (window.innerWidth <= 850) $('.photo').on('click', magnifyPhoto);
    });

    $(window).resize(function() {
      if (window.innerWidth > 850) {
        if (show) $("#photoAlbum").turn('size', '70%', '50vh');
        else {
          $("#photoAlbum").turn({
            width: '70%',
            height: '50vh',
            autoCenter: true
          });
          show = true;
        }
      } else {
        if (show) {
          $("#photoAlbum").turn("destroy").remove();
          const e = document.createElement('div');
          $(e).attr('id', "photoAlbum");
          $(e).html(insideAlbum);
          $('#zoomImg').before(e);
          show = false;
          setTimeout(() => window.location.reload());
        }
      } 
    });

    $("#photoAlbum").bind("turned", function(event, page, view) {
      $('.photo').off('click');
      $('.bookmark').off('click');
      $('.deleteBtn').off('click');

      $('.photo').on('click', magnifyPhoto);
      
      $('.bookmark').on('click', function () {
        const pageNum = $(this).next().text();
        if ($(this).find('i').is('.far')) {
          $(this).empty().append('<i class="fas">&#xf005;</i>');
          $(this).css('color', 'orange');
          $(this).attr('title', '取消書籤');
          $('#pages > option').eq(pageNum).text(`${pageNum}  🌟`);
        } else {
          $(this).empty().append('<i class="far">&#xf005;</i>');
          $(this).css('color', 'black');
          $(this).attr('title', '加入書籤');
          $('#pages > option').eq(pageNum).text(pageNum);
        }        
      });

      $('.deleteBtn').on('click', function () {
        if ($(this).find('i').is('.fas')) {
          $(this).empty().append('<i class="far">&#xf1c5;</i>');
          $(this).css('color', 'lightskyblue');
          $(this).next().hide();
          garbageCan[$(this).next().attr('id')] = true;
          $(this).attr('title', '貼回照片');
        } else {
          $(this).empty().append('<i class="fas">&#xf0c4;</i>');
          $(this).css('color', 'gray');
          $(this).next().show();
          garbageCan[$(this).next().attr('id')] = false;
          $(this).attr('title', '剪下照片');
        }
      });
    });